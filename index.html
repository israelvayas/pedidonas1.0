<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç© Registro de Pedidos (Firebase)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- Paleta de Colores Unisex y Modernos --- */
        :root {
            --color-principal: #00BCD4; /* Cian Claro */
            --color-secundario: #4CAF50; /* Verde Menta (√âxito) */
            --color-fondo: #F5F5F5;
            --color-texto: #333;
            --color-sombra: rgba(0, 0, 0, 0.15);
            --color-advertencia: #F44336; /* Rojo */
            --color-gris: #9E9E9E;
            --color-resalte: #FFC107; /* Amarillo para resaltar */
            --color-editar: #2196F3; /* Azul para Editar */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .contenedor-registro {
            background-color: white;
            padding: 30px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--color-sombra);
            width: 100%;
            max-width: 450px;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--color-principal);
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        .formulario-grupo {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            color: var(--color-texto);
            font-size: 0.9em;
        }

        input[type="text"],
        textarea,
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-gris);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            border-color: var(--color-principal);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 50px;
        }

        .resultado-total {
            padding: 10px;
            background-color: var(--color-principal);
            color: white;
            border-radius: 6px;
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .resultado-total span#totalPagar {
            background-color: var(--color-resalte); 
            padding: 4px 10px;
            border-radius: 4px;
            color: var(--color-texto);
        }

        .botones-accion {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: space-between;
        }
        
        .botones-accion button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* BOT√ìN REGISTRAR RESALTADO */
        #btnRegistrar {
            flex: 2; 
            background-color: var(--color-secundario);
            color: white;
            font-size: 1.1em;
            box-shadow: 0 4px 0 #388E3C; 
        }
        #btnRegistrar:active {
            box-shadow: none;
            transform: translateY(4px);
        }
        
        #btnVerPedidos {
            flex: 1; 
            background-color: var(--color-gris);
            color: white;
        }

        /* --- Estilos de los Modales (Ventana de Pedidos y Edici√≥n) --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); 
            padding: 15px;
        }

        .modal-contenido {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 20px var(--color-sombra);
            width: 95%;
            max-width: 700px;
        }
        
        #modalEdicion .modal-contenido {
            max-width: 450px; /* Modal de edici√≥n m√°s peque√±o */
            margin-top: 10%;
        }

        .cerrar-modal {
            color: var(--color-gris);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        /* --- ESTILOS DE TABLA Y BOTONES MEJORADOS --- */
        #tablaPedidos {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: #000;
        }
        
        #tablaPedidos th, #tablaPedidos td {
            padding: 8px;
            border: 1px solid #eee;
            text-align: left;
            font-size: 0.85em;
        }
        /* Ajuste de ancho para la columna de acciones */
        #tablaPedidos th:last-child, #tablaPedidos td:last-child {
            width: 1%; 
            white-space: nowrap; 
        }

        #tablaPedidos th {
            background-color: var(--color-principal);
            color: white;
            font-weight: 700;
        }
        
        /* ESTILO PARA PEDIDOS ENTREGADOS (TACHADO Y GRIS PLOMO) */
        #tablaPedidos tr.entregado td {
            text-decoration: line-through;
            color: #A9A9A9;
            opacity: 0.8;
            font-style: italic;
        }
        
        #tablaPedidos tr.entregado .btn-pedido-accion {
            text-decoration: none; 
            opacity: 1;
        }
        
        /* Estilo para el pie de tabla */
        #tablaPedidos tfoot td {
            background-color: #e0f7fa; 
            font-weight: 700;
            font-size: 1em;
        }

        /* ESTILOS DE BOTONES DE ACCI√ìN COMPACTOS CON ICONOS */
        .btn-pedido-accion {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin: 0 2px;
            padding: 3px;
            transition: color 0.2s;
        }
        .btn-pedido-accion:hover {
            opacity: 0.8;
        }

        /* Colores espec√≠ficos de los botones de acci√≥n */
        .btn-entregado { color: var(--color-secundario); }
        .btn-deshacer { color: var(--color-advertencia); }
        .btn-eliminar { color: #555; }
        .btn-editar { color: var(--color-editar); }
        
        /* Bot√≥n de Guardar en Modal de Edici√≥n */
        #btnGuardarEdicion {
            background-color: var(--color-editar);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: background-color 0.2s;
        }
        #btnGuardarEdicion:hover {
            background-color: #1976D2; /* Azul m√°s oscuro al pasar el rat√≥n */
        }

        /* CONTENEDOR DE TOASTS (Sin cambios) */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
        }
        .toast {
            min-width: 250px;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-20px);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            background-color: var(--color-secundario);
        }
        .toast.error {
            background-color: var(--color-advertencia);
        }
    </style>
</head>
<body>

    <div class="contenedor-registro">
        <h1>üç© Nuevo Pedido R√°pido</h1>

        <div class="formulario-grupo">
            <label for="nombreCliente">Cliente:</label>
            <input type="text" id="nombreCliente" placeholder="Nombre del cliente" required>
        </div>

        <div class="formulario-grupo">
            <label for="descripcionPedido">Descripci√≥n:</label>
            <textarea id="descripcionPedido" placeholder="Sabores, Cantidad, Toppings..." required></textarea>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <div class="formulario-grupo" style="flex: 1;">
                <label for="cantidadDonas">Cant:</label>
                <input type="number" id="cantidadDonas" min="1" value="1" oninput="calcularTotal()" required>
            </div>
            <div class="formulario-grupo" style="flex: 1;">
                <label for="precioUnitario">Precio Unit:</label>
                <input type="number" id="precioUnitario" min="0.01" step="0.01" value="1.50" oninput="calcularTotal()" required>
            </div>
        </div>

        <div class="resultado-total">
            <span>TOTAL:</span>
            <span id="totalPagar">$ 1.50</span>
        </div>
        
        <div class="botones-accion">
            <button id="btnRegistrar" onclick="registrarPedido()">‚ú® Registrar Pedido</button>
            <button id="btnVerPedidos" onclick="abrirModal()">üëÅÔ∏è Ver Pedidos</button>
        </div>
        
    </div>

    <div id="modalPedidos" class="modal">
        <div class="modal-contenido">
            <span class="cerrar-modal" onclick="cerrarModal()">&times;</span>
            <h2>üìù Pedidos Registrados</h2>
            
            <div style="overflow-x: auto;">
                <table id="tablaPedidos">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Descripci√≥n</th>
                            <th>Total</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="listaPedidos">
                        <tr><td colspan="4" style="text-align: center;">Cargando pedidos...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" style="text-align: right;">TOTAL GENERAL:</td>
                            <td id="totalGeneral" colspan="2">$ 0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

        </div>
    </div>
    
    <div id="modalEdicion" class="modal">
        <div class="modal-contenido">
            <span class="cerrar-modal" onclick="cerrarModalEdicion()">&times;</span>
            <h2>‚úèÔ∏è Editar Pedido</h2>
            
            <div id="formularioEdicion">
                <input type="hidden" id="editId">
                
                <div class="formulario-grupo">
                    <label for="editNombre">Cliente:</label>
                    <input type="text" id="editNombre" required>
                </div>

                <div class="formulario-grupo">
                    <label for="editDescripcion">Descripci√≥n:</label>
                    <textarea id="editDescripcion" required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <div class="formulario-grupo" style="flex: 1;">
                        <label for="editCantidad">Cant:</label>
                        <input type="number" id="editCantidad" min="1" oninput="calcularTotalEdicion()" required>
                    </div>
                    <div class="formulario-grupo" style="flex: 1;">
                        <label for="editPrecioUnitario">Precio Unit:</label>
                        <input type="number" id="editPrecioUnitario" min="0.01" step="0.01" oninput="calcularTotalEdicion()" required>
                    </div>
                </div>

                <div class="resultado-total">
                    <span>TOTAL A PAGAR:</span>
                    <span id="editTotalPagar">$ 0.00</span>
                </div>
                
                <button id="btnGuardarEdicion" onclick="guardarEdicion()">üíæ Guardar Cambios</button>
            </div>
            
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        // Importar las funciones necesarias de Firebase SDK (v9+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // 1. Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDvAkI_aBIiezkbSEwgdmpduaGKtw4XLOs",
            authDomain: "controlceo-fdd05.firebaseapp.com",
            projectId: "controlceo-fdd05",
            storageBucket: "controlceo-fdd05.firebasestorage.app",
            messagingSenderId: "207151362101",
            appId: "1:207151362101:web:4045b3c12f28bc0e55417c"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const PEDIDOS_COLLECTION = "pedidos_minidonas";
        const pedidosRef = collection(db, PEDIDOS_COLLECTION);
        
        let pedidos = []; 
        
        // --- FUNCI√ìN DE TOAST (NOTIFICACI√ìN FLOTANTE) ---
        function mostrarToast(mensaje, tipo) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.textContent = mensaje;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10); 

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // --- FUNCIONES DE L√ìGICA DE NEGOCIO Y CRUD ---
        
        window.calcularTotal = function() {
            const cantidad = parseFloat(document.getElementById('cantidadDonas').value) || 0;
            const precio = parseFloat(document.getElementById('precioUnitario').value) || 0;
            const total = cantidad * precio;
            
            document.getElementById('totalPagar').textContent = `$ ${total.toFixed(2)}`;
            return total;
        }
        
        // **NUEVA FUNCI√ìN** para calcular el total en el modal de edici√≥n
        window.calcularTotalEdicion = function() {
            const cantidad = parseFloat(document.getElementById('editCantidad').value) || 0;
            const precio = parseFloat(document.getElementById('editPrecioUnitario').value) || 0;
            const total = cantidad * precio;
            
            document.getElementById('editTotalPagar').textContent = `$ ${total.toFixed(2)}`;
            return total;
        }

        window.registrarPedido = async function() {
            const nombre = document.getElementById('nombreCliente').value.trim();
            const descripcion = document.getElementById('descripcionPedido').value.trim();
            const cantidad = parseInt(document.getElementById('cantidadDonas').value);
            const precioUnitario = parseFloat(document.getElementById('precioUnitario').value);
            const total = calcularTotal();

            if (!nombre || !descripcion || cantidad < 1 || total <= 0) {
                mostrarToast('‚ùå Por favor, completa todos los campos correctamente.', 'error');
                return;
            }

            try {
                const nuevoPedido = {
                    nombre: nombre,
                    descripcion: descripcion,
                    cantidad: cantidad,
                    precioUnitario: precioUnitario,
                    total: total,
                    entregado: false,
                    timestamp: Date.now() 
                };

                await addDoc(pedidosRef, nuevoPedido);
                
                mostrarToast(`‚úÖ Pedido de ${nombre} registrado con √©xito en la nube.`, 'success');
                
                document.getElementById('nombreCliente').value = '';
                document.getElementById('descripcionPedido').value = '';
                document.getElementById('cantidadDonas').value = '1';
                document.getElementById('precioUnitario').value = '1.50';
                calcularTotal(); 

                if (document.getElementById('modalPedidos').style.display === 'block') {
                    await cargarPedidos();
                }

            } catch (e) {
                console.error("Error a√±adiendo documento: ", e);
                mostrarToast(`üõë Error al registrar: ${e.message}`, 'error');
            }
        }
        
        window.cargarPedidos = async function() {
            const listaPedidos = document.getElementById('listaPedidos');
            listaPedidos.innerHTML = '<tr><td colspan="4" style="text-align: center;">Cargando...</td></tr>';

            try {
                const q = query(pedidosRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                pedidos = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.precioUnitario === undefined) {
                        data.precioUnitario = (data.total / data.cantidad) || 0;
                    }
                    pedidos.push({ id: doc.id, ...data });
                });

                actualizarListaPedidosUI();

            } catch (e) {
                console.error("Error cargando pedidos: ", e);
                mostrarToast('üõë Error al cargar los pedidos de Firebase.', 'error');
                listaPedidos.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error al cargar los datos.</td></tr>';
            }
        }
        
        function actualizarListaPedidosUI() {
            const listaPedidos = document.getElementById('listaPedidos');
            listaPedidos.innerHTML = '';
            let totalAcumulado = 0;

            if (pedidos.length === 0) {
                listaPedidos.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay pedidos registrados.</td></tr>';
                document.getElementById('totalGeneral').textContent = `$ 0.00`;
                return;
            }

            pedidos.forEach(pedido => {
                const newRow = listaPedidos.insertRow();
                newRow.className = pedido.entregado ? 'entregado' : '';
                
                // Cliente y descripci√≥n 
                newRow.insertCell().textContent = pedido.nombre;
                newRow.insertCell().textContent = `${pedido.descripcion} (${pedido.cantidad} u.)`; 
                
                // Total
                newRow.insertCell().textContent = `$ ${pedido.total.toFixed(2)}`;

                // Botones de acci√≥n
                const accionCell = newRow.insertCell();
                
                // 1. Bot√≥n Editar (AHORA ABRE EL MODAL PERSONALIZADO)
                const btnEditar = document.createElement('button');
                btnEditar.className = 'btn-pedido-accion btn-editar';
                btnEditar.title = 'Editar Pedido';
                btnEditar.innerHTML = '‚úèÔ∏è'; 
                btnEditar.onclick = () => abrirModalEdicion(pedido); // Cambiado
                accionCell.appendChild(btnEditar);

                // 2. Bot√≥n Entregado/Pendiente
                const btnEntregado = document.createElement('button');
                const esEntregado = pedido.entregado;
                btnEntregado.className = `btn-pedido-accion ${esEntregado ? 'btn-deshacer' : 'btn-entregado'}`;
                btnEntregado.title = esEntregado ? 'Marcar como Pendiente' : 'Marcar como Entregado';
                btnEntregado.innerHTML = esEntregado ? '‚Ü©Ô∏è' : '‚úÖ';
                btnEntregado.onclick = () => alternarEntregado(pedido.id, !esEntregado);
                accionCell.appendChild(btnEntregado);

                // 3. Bot√≥n Eliminar
                const btnEliminar = document.createElement('button');
                btnEliminar.className = 'btn-pedido-accion btn-eliminar';
                btnEliminar.title = 'Eliminar Pedido';
                btnEliminar.innerHTML = 'üóëÔ∏è';
                btnEliminar.onclick = () => eliminarPedido(pedido.id);
                accionCell.appendChild(btnEliminar);
                
                totalAcumulado += pedido.total;
            });
            
            document.getElementById('totalGeneral').textContent = `$ ${totalAcumulado.toFixed(2)}`;
        }
        
        window.alternarEntregado = async function(id, estado) {
            try {
                const pedidoDoc = doc(db, PEDIDOS_COLLECTION, id);
                await updateDoc(pedidoDoc, {
                    entregado: estado
                });
                mostrarToast(`‚úîÔ∏è Pedido actualizado a ${estado ? 'Entregado' : 'Pendiente'}.`, 'success');
                await cargarPedidos(); 
            } catch (e) {
                console.error("Error actualizando pedido: ", e);
                mostrarToast('üõë Error al actualizar el pedido.', 'error');
            }
        }
        
        window.eliminarPedido = async function(id) {
            if (!confirm("‚ö†Ô∏è ¬øSeguro desea eliminar este pedido permanentemente? Esta acci√≥n no se puede deshacer.")) {
                return;
            }

            try {
                await deleteDoc(doc(db, PEDIDOS_COLLECTION, id));
                mostrarToast('üóëÔ∏è Pedido eliminado correctamente.', 'success');
                await cargarPedidos(); 
            } catch (e) {
                console.error("Error eliminando pedido: ", e);
                mostrarToast('üõë Error al eliminar el pedido.', 'error');
            }
        }
        
        // --- FUNCIONES PARA EL MODAL DE EDICI√ìN ---
        
        /**
         * Abre el modal de edici√≥n y precarga los datos del pedido.
         */
        window.abrirModalEdicion = function(pedido) {
            // Cargar ID (oculto)
            document.getElementById('editId').value = pedido.id;
            
            // Cargar datos de campos
            document.getElementById('editNombre').value = pedido.nombre;
            document.getElementById('editDescripcion').value = pedido.descripcion;
            document.getElementById('editCantidad').value = pedido.cantidad;
            document.getElementById('editPrecioUnitario').value = pedido.precioUnitario.toFixed(2);
            
            // Recalcular y mostrar el total actual
            calcularTotalEdicion();
            
            // Mostrar el modal
            document.getElementById('modalEdicion').style.display = 'block';
        }

        /**
         * Cierra el modal de edici√≥n.
         */
        window.cerrarModalEdicion = function() {
            document.getElementById('modalEdicion').style.display = 'none';
        }
        
        /**
         * Lee los datos del modal de edici√≥n y actualiza el documento en Firebase.
         */
        window.guardarEdicion = async function() {
            const id = document.getElementById('editId').value;
            const nuevoNombre = document.getElementById('editNombre').value.trim();
            const nuevaDescripcion = document.getElementById('editDescripcion').value.trim();
            const nuevaCantidad = parseInt(document.getElementById('editCantidad').value);
            const nuevoPrecio = parseFloat(document.getElementById('editPrecioUnitario').value);
            const nuevoTotal = calcularTotalEdicion();

            if (!nuevoNombre || !nuevaDescripcion || nuevaCantidad < 1 || nuevoPrecio <= 0) {
                mostrarToast('‚ùå Por favor, completa todos los campos de edici√≥n correctamente.', 'error');
                return;
            }
            
            try {
                const pedidoDoc = doc(db, PEDIDOS_COLLECTION, id);
                await updateDoc(pedidoDoc, {
                    nombre: nuevoNombre,
                    descripcion: nuevaDescripcion,
                    cantidad: nuevaCantidad,
                    precioUnitario: nuevoPrecio,
                    total: nuevoTotal
                });
                
                mostrarToast(`‚úèÔ∏è Pedido de ${nuevoNombre} actualizado correctamente.`, 'success');
                cerrarModalEdicion(); 
                await cargarPedidos(); 
                
            } catch (e) {
                console.error("Error guardando edici√≥n: ", e);
                mostrarToast('üõë Error al guardar los cambios.', 'error');
            }
        }


        // --- Funciones para el Modal General de Pedidos ---
        window.abrirModal = async function() {
            document.getElementById('modalPedidos').style.display = 'block';
            await cargarPedidos(); 
        }

        window.cerrarModal = function() {
            document.getElementById('modalPedidos').style.display = 'none';
        }
        
        // Cierre de modales al hacer clic fuera
        window.onclick = function(event) {
            const modalPedidos = document.getElementById('modalPedidos');
            const modalEdicion = document.getElementById('modalEdicion');
            
            if (event.target === modalPedidos) {
                cerrarModal();
            }
            if (event.target === modalEdicion) {
                cerrarModalEdicion();
            }
        }

        window.onload = calcularTotal;
    </script>

</body>
</html>